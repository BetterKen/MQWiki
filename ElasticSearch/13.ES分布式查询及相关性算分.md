# 13 ES分布式查询及相关性算分

## 13.1 分布式搜索的运行机制

ES的搜索会分两个阶段进行:

- 第一阶段－－Query
- 第二阶段－－Fetch



因此我们称ES的搜索运行机制为 **Query-Then-Fetch**



## 13.2 Query阶段

![](http://dist415.oss-cn-beijing.aliyuncs.com/esquery.png)

## 13.3  Fetch阶段
![](http://dist415.oss-cn-beijing.aliyuncs.com/esfetch.png)



## 13.4 Query Then Fetch 潜在的问题

### 13.4.1 深度分页

![](http://dist415.oss-cn-beijing.aliyuncs.com/esfromsize.png)



- **每个分片上需要查的文档个数=from + size**
- **最终协调节点需要处理：number_of_shard * ( from+size )**
- **导致深度分页**

![](http://dist415.oss-cn-beijing.aliyuncs.com/esdeep.png)



### 13.4.2 相关性算分
**每个分片都基于自己的分片上的数据进行相关度计算**。

这会导致打分偏离的情况，特别是数据量很少时。相关性算分在分片之间是相互独立。当文档总数很少的情况下，如果主分片大于1,主分片数越多，相关性算分会越不准



## 13.5 解决问题

todo

### 13.4.1 深度分页

#### 13.4.1.1 search after

#### 13.4.1.2 scroll API

### 13.4.2 相关性算分

