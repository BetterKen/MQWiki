# 11 ES集群规划

## 11.1 分片

### 11.1.1 如何确定主分片数

- 从存储的物理角度看

  - 日志类应用，单个分片不要大于50 GB

  - 搜索类应用，单个分片不要超过20 GB

- 为什么要控制分片存储大小

  - 提高Update的性能
  - Merge时，减少所需的资源
  - 丢失节点后，具备更快的恢复速度/便于分片在集群内Rebalancing

### 11.1.2 如何确定副本分片数

- 副本是主分片的拷贝

  - 提高系统可用性：相应査询请求，防止数据丢失

  - 需要占用和主分片一样的资源

- 对性能的影响
  - 副本会降低数据的索引速度：有几份副本就会有几倍的CPU资源消耗在索引上
  - 会减缓对主分片的査询压力，但是会消耗同样的内存资源
    - 如果机器资源充分，提高副本数，可以提高整体的査询QPS



## 11.2 硬件配置

- 选择合理的硬件，数据节点尽可能使用SSD
- 搜索等性能要求高的场景，建议SSD

  - **按照1 ： 10的比例配置内存和硬盘**
- 日志类和查询并发低的场景，可以考虑使用机械硬盘存储
  - **按照1： 50的比例配置内存和硬盘**
- 单节点数据建议控制在2TB以内，最大不建议超过5TB
- JVM配置机器内存的一半，JVM内存配置不建议超过32G

## 11.3 部署方式

- 按需选择合理的部署方式，线上定要选择集群模式
- 如果需要考虑可靠性高可用，建议**部署3台以上的dedicated的Master节点**
- 如果有复杂的查询和聚合，建议设置Coordinating节点



## 11.4 JVM设定

- 从ES 6开始，只支持64位的JVM

  - 配置 config / jvm. options

- 避免修改默认配置
  - 将内存Xms和Xmx设置成一样，避免heap resize时引发停顿
  -  Xmx设置不要超过物理内存的50%；单个节点上，最大内存建议不要超过32 G内存
  - 生产环境，JVM必须使用Server模式
  - 关闭 JVM Swapping



## 11.5 内存设定计算实例

- 内存大小要根据 Node 需要存储的数据来进行估算  

  - 搜索类的比例建议：1:16 

  - 日志类： 1:48 - 1:96 之间 
- 总数据量 1T， 设置一个副本 = 2T 总数据量 
  - 一台机器假设总内存为32G,可用内存为31G
  -  如果搜索类的项目，每个节点 ```31 *16 = 496G```，加上预留空间。所以每个节点最多 400 G 数据，至少需 要 5 个数据节点 
  - 如果是日志类项目，每个节点 ```31*50 = 1550GB```，2 个数据节点 即可